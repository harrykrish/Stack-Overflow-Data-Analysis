{"title": "Pandas: sort within groupby on a particular column", "tags": ["pandas"], "creation_date": 1477610008, "score": 2, "body": "<blockquote>\n  <p>How can I just sort by that column but keep the sorting constrained within the group?</p>\n</blockquote>\n\n<p>Sort by both <code>item_name</code> and <code>count</code>. Since <code>item_name</code> is an index level, and <code>count</code> is a column, we must either move <code>item_name</code> to a column and call <code>DataFrame.sort_values</code> or move <code>count</code> into the index and call <code>DataFrame.sortlevel</code>.</p>\n\n<p>For example</p>\n\n<pre><code>import pandas as pd\nchipo = pd.read_csv('chipotle.tsv', sep='\\t')\ndel chipo['order_id']\ndel chipo['quantity']\nchipo['revenue'] = chipo['item_price'].str.replace('$','').astype(float)\nchipo['count'] = 1\nresult = chipo.groupby(['item_name','choice_description']).sum()\n\nresult = (result.set_index('count', append=True)\n            .sortlevel(axis=0, level=['item_name', 'count'], ascending=False)\n            .reset_index('count', drop=False))\n</code></pre>\n\n<p>yields</p>\n\n<pre><code>                                                                          revenue  \\\n                                                                      revenue  count\nitem_name             choice_description                                                \nVeggie Salad Bowl     [Fresh Tomato Salsa, [Fajita Vegetables, Lettuc...    11.25      1\n                      [Fresh Tomato Salsa, [Fajita Vegetables, Rice, ...    11.25      1\n                      [Fresh Tomato Salsa, [Fajita Vegetables, Rice, ...    11.25      1\n                      [Fresh Tomato Salsa, [Rice, Lettuce, Guacamole,...    11.25      1\n...                      \nBarbacoa Bowl         [Roasted Chili Corn Salsa, [Fajita Vegetables, ...    23.50      2\n                      [Fresh Tomato Salsa, [Fajita Vegetables, Rice, ...     9.25      1\n                      [Fresh Tomato Salsa, [Fajita Vegetables, Rice, ...     9.25      1\n                      [Tomatillo Red Chili Salsa, [Fajita Vegetables,...    11.75      1\n                      [Tomatillo Red Chili Salsa, [Rice, Black Beans,...     9.25      1\n                      [Tomatillo Red Chili Salsa, [Rice, Cheese, Lett...     9.25      1\n                      [Tomatillo Red Chili Salsa, [Rice, Pinto Beans,...     9.25      1\n                      [[Tomatillo-Green Chili Salsa (Medium), Roasted...    11.48      1\n                      [[Tomatillo-Red Chili Salsa (Hot), Tomatillo-Gr...     8.99      1\n6 Pack Soft Drink     [Diet Coke]                                           19.47      3\n                      [Coke]                                                 6.49      1\n                      [Sprite]                                               6.49      1\n\n[314 rows x 2 columns]\n</code></pre>\n\n<hr>\n\n<p>Of the two options above, using <code>sortlevel</code> is a bit quicker than <code>sort_values</code>. \nHere is a benchmark:</p>\n\n<pre><code>In [73]: %timeit using_sortlevel(totals)\n10 loops, best of 3: 148 ms per loop\n\nIn [74]: %timeit using_sort_values(totals)\n10 loops, best of 3: 174 ms per loop\n</code></pre>\n\n<p>using this setup:</p>\n\n<pre><code>import pandas as pd\nN = 10**6\nchipo = pd.DataFrame(np.random.randint(1000, size=(N,4)), columns=list('ABCD'))\ntotals = chipo.groupby(['A','B']).sum()\n\ndef using_sortlevel(df):\n    return (df.set_index('C', append=True)\n            .sortlevel(axis=0, level=['A', 'C'], ascending=False)\n            .reset_index('C', drop=False))\n\ndef using_sort_values(df):\n    return (df.reset_index('A')\n            .sort_values(by=['A', 'C'], ascending=False)\n            .set_index('A', append=True)\n            .swaplevel(0, 1, axis=0))\n</code></pre>\n", "last_activity_date": 1477697783, "answer_id": 40295606, "is_accepted": true, "owner": {"user_id": 190597, "reputation": 385809, "user_type": "registered", "accept_rate": 88, "display_name": "unutbu", "link": "http://stackoverflow.com/users/190597/unutbu", "profile_image": "https://www.gravatar.com/avatar/aabc98d5c6482ca0e1405ec97710f30a?s=128&d=identicon&r=PG&f=1"}, "last_edit_date": 1477697783, "question_id": 40295468}