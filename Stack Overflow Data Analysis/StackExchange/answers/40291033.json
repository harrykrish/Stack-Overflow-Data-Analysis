{"title": "Visual C linker behaves differently on 32-bit and 64-bit", "tags": ["c", "visual-c++", "dll"], "creation_date": 1477590107, "score": 1, "body": "<p><strong>Edited to correct error spotted by IInspectable and for clarity</strong></p>\n\n<h1>32-bit</h1>\n\n<p>The default calling convention is <a href=\"https://msdn.microsoft.com/en-us/library/46t77ak2.aspx\" rel=\"nofollow\"><code>__cdecl</code></a>, which causes the symbol name to be prepended with an underscore:  <code>_FreeLibrary</code>.</p>\n\n<pre><code>&gt;dumpbin /symbols test.o | find \"FreeLibrary\"\n008 00000000 SECT3  notype ()    External     | _FreeLibrary\n</code></pre>\n\n<p>The <code>FreeLibrary</code> in kernel32.dll is declared with <code>WINAPI</code>.  In 32-bit, <code>WINAPI</code> expands to <code>__stdcall</code>, so kernel32's function is named <code>_FreeLibrary@4</code>.</p>\n\n<pre><code>&gt;dumpbin /exports kernel32.lib | find \"FreeLibrary\"\n    _FreeLibrary@4\n    _FreeLibraryAndExitThread@8\n    _FreeLibraryWhenCallbackReturns@8\n</code></pre>\n\n<p>Since <code>_FreeLibrary</code> doesn't match <code>_FreeLibrary@4</code>, there's no conflict.</p>\n\n<h1>64-bit</h1>\n\n<p>The default calling convention is a <a href=\"https://msdn.microsoft.com/en-us/library/ms235286.aspx\" rel=\"nofollow\">four-register fastcall</a> scheme that does not decorate the name of a plain C function.  Thus test.o defines a symbol named <code>FreeLibrary</code>:</p>\n\n<pre><code>&gt;dumpbin /symbols test.o | find \"FreeLibrary\"\n008 00000000 SECT3  notype ()    External     | FreeLibrary\n</code></pre>\n\n<p>Also, the <code>WINAPI</code> macro expands to nothing, so kernel32.dll uses the same default calling convention as your plugin code.  Thus it gets the same, unadorned symbol:</p>\n\n<pre><code>&gt;dumpbin /exports kernel32.lib | find \"FreeLibrary\"\n    FreeLibrary\n    FreeLibraryAndExitThread\n    FreeLibraryWhenCallbackReturns\n</code></pre>\n\n<p>This gives you two <code>FreeLibrary</code> symbols and results in the linker error.</p>\n", "last_activity_date": 1477672768, "answer_id": 40291033, "is_accepted": true, "owner": {"user_id": 1386054, "reputation": 24459, "user_type": "registered", "accept_rate": 94, "display_name": "Adrian McCarthy", "link": "http://stackoverflow.com/users/1386054/adrian-mccarthy", "profile_image": "https://i.stack.imgur.com/424ZW.jpg?s=128&g=1"}, "last_edit_date": 1477672768, "question_id": 40289429}