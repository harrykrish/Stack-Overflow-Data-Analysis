{"body": "<p>You're trying to do something too complex to be handled (gracefully) in one line, so we'll need to break it down a bit.  First, let's get the snapshots sorted by age, oldest to newest:</p>\n\n<p><code>aws ec2 describe-snapshots --filters Name=description,Values=$Description --query 'Snapshots[*].[StartTime,SnapshotId]' --output text | sort -n</code></p>\n\n<p>Then we drop the StartTime field to get the snapshot ID alone:</p>\n\n<p><code>aws ec2 describe-snapshots --filters Name=description,Values=$Description --query 'Snapshots[*].[StartTime,SnapshotId]' --output text | sort -n | sed -e 's/^.*\\t//</code></p>\n\n<p><code>head</code> (or <code>tail</code>) aren't really suitable for discarding the fixed number of snapshots we want to keep.  We need to filter those out another way.  So, putting it altogether:</p>\n\n<pre><code># Get array of snapshot IDs sorted by age (oldest to newest)\nsnapshots=($(aws ec2 describe-snapshots --filters Name=description,Values=$Description --query 'Snapshots[*].[StartTime,SnapshotId]' --output text | sort -n | sed -e 's/^.*\\t//))\n# Get number of snapshots\ncount=${#snapshots[@]}\n\nif [ \"$count\" -lt \"$Local_numbackups\" ]; then\n  echo \"We already have less than $Local_numbackups snapshots\"\n  exit 0\nelse\n  # Drop the last (newest) $Local_numbackups IDs from the array\n  snapshots=(${snapshots[@]:0:$((count - Local_numbackups))})\n  # Loop through the remaining snapshots and delete\n  for snapshot in ${snapshots[@]}; do\n    aws ec2 delete-snapshot --snapshot-id $snapshot\n  done\nfi\n</code></pre>\n\n<p>(While it's obviously possible to do this in bash with the AWS CLI, it's complex enough that I'd personally rather use a more robust language and the AWS SDK.)</p>\n", "tags": ["amazon-web-services", "amazon-ec2"], "creation_date": 1464034187, "score": 1, "last_activity_date": 1464034187, "answer_id": 37399664, "is_accepted": true, "owner": {"user_id": 6047960, "reputation": 1077, "user_type": "registered", "display_name": "Karen B", "link": "http://stackoverflow.com/users/6047960/karen-b", "profile_image": "https://www.gravatar.com/avatar/0a37bc0cc9fe7dd8dda91e4f4de592ae?s=128&d=identicon&r=PG&f=1"}, "title": "Delete the oldest AWS EC2 snapshots", "question_id": 37378630}