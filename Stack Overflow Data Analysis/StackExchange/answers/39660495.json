{"title": "PHP foreach issue when separating values", "tags": ["php", "mysql", "foreach"], "creation_date": 1474632737, "score": 1, "body": "<p>Apart from the coding mistakes, the reason it's only sending the email to a single manager is because the manager bit only gets executed once. Your 2nd query:</p>\n\n<pre><code>SELECT userEmail FROM `users` WHERE userName='\".$manager.\"'\n</code></pre>\n\n<p>will return a set of users where the username is equal to the LAST $manager from the previous loop because this bit of code is NOT inside the first loop.</p>\n\n<p>Simply moving this bit of code inside the loop will fix your initial issue. The rest of the fixes can be found below:</p>\n\n<pre><code>include (\"../dbconnect.php\");\n\n$sql='SELECT * FROM `clients` WHERE endofmonthform=\"22/09/2016\"'; //TODAYS DATE BACK HERE!\n\n$result=mysql_query($sql); \n\n while($row=mysql_fetch_array($result)){  \n\n    $enddate = $row['endofmonthform']; // End\n\n    $startdate = $row['startofmonthform']; // Start\n\n    $email = $row['email']; //Email to send email to\n\n    $id = $row['id'];\n\n    $formlevel = $row['formlevel']; //To update and check formlevel\n\n    $sitegroupname = $row['mastersite'];\n\n    $manager = $row['opmanager'];\n\n\n    $query=\"SELECT userEmail FROM `users` WHERE userName='\".$manager.\"'\";\n    $result=mysql_query($query); \n\n    while($row=mysql_fetch_array($result)){  \n        echo $row['userEmail']; //Where send email function will be\n    }\n\n}\n</code></pre>\n\n<p>That said, this is still bad code.... It uses a deprecated API (mysql_) and it's vulnerable to SQL injection. Take a look at <a href=\"http://php.net/manual/en/book.mysqli.php\" rel=\"nofollow\">mysqli</a> or <a href=\"http://php.net/manual/en/book.pdo.php\" rel=\"nofollow\">pdo</a> for a better API and <a href=\"http://php.net/manual/en/pdo.prepared-statements.php\" rel=\"nofollow\">prepared statements</a> for the SQL injection issue.</p>\n\n<p>If you want to easily use a database with php you could have a look my pdoWrapper: <a href=\"https://github.com/Mastermindzh/pdoWrapper\" rel=\"nofollow\">https://github.com/Mastermindzh/pdoWrapper</a> </p>\n\n<p>Edit:</p>\n\n<p>As pointed out in the comments one could, really should, use a join to get this data. This might be a little much for the TS/OP to understand at this point but I will add it anyways for the sake of completeness:</p>\n\n<pre><code>include (\"../dbconnect.php\");\n\n$sql='SELECT c.endofmonthform, c.startofmonthform, c.email, c.id, c.formlevel, c.mastersite, c.opmanager, u.userEmail FROM `clients` as c LEFT JOIN `users` as u on c.opmanager = u.userName WHERE endofmonthform=\"22/09/2016\"'; //TODAYS DATE BACK HERE!\n\n$result=mysql_query($sql); \n\n while($row=mysql_fetch_array($result)){  \n\n    $enddate = $row['endofmonthform']; // End\n\n    $startdate = $row['startofmonthform']; // Start\n\n    $email = $row['email']; //Email to send email to\n\n    $id = $row['id'];\n\n    $formlevel = $row['formlevel']; //To update and check formlevel\n\n    $sitegroupname = $row['mastersite'];\n\n    $manager = $row['opmanager'];\n\n    echo $row['userEmail']; //Where send email function will be\n\n}\n</code></pre>\n", "last_activity_date": 1474636501, "answer_id": 39660495, "is_accepted": true, "owner": {"user_id": 5033031, "reputation": 464, "user_type": "registered", "accept_rate": 80, "display_name": "Rick van Lieshout", "link": "http://stackoverflow.com/users/5033031/rick-van-lieshout", "profile_image": "https://lh5.googleusercontent.com/-K3kbNrRBQ2g/AAAAAAAAAAI/AAAAAAAAATE/XxcsC4rT39o/photo.jpg?sz=128"}, "last_edit_date": 1474636501, "question_id": 39660014}