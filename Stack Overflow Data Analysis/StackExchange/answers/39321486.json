{"body": "<p>Got it.</p>\n\n<pre><code>giniImpurities &lt;- function(dt){\n  # Returns pairs of categorical fields (cat1, cat2, GI) where GI is the weighted gini impurity of \n  # cat2 relative to the groups determined by cat1\n\n  #--------------------------------------------------\n  # Subset dt by just the categorical fields\n\n  catfields &lt;- colnames(dt)[sapply(dt, is.factor)]\n  cats1 &lt;- dt[, catfields, with=FALSE]\n\n  # Build a table to store the results\n  varpairs &lt;- CJ(Var1=catfields, Var2=catfields)\n  varpairs[Var1==Var2, GI := 0]\n\n  # Loop through each grouping variable\n  for(catcol in catfields){\n    print(paste(\"Calculating gini impurities by field:\", catcol))\n\n    setkeyv(cats1, catcol)\n    impuritiesDT &lt;- cats1[, list(Samples=.N), keyby=catcol]\n\n    # Looop through each of the other categorical columns\n    for(colname in setdiff(catfields, catcol)){\n\n      # Get the gini impurity for each pair (catcol, other)\n      counts &lt;- cats1[, list(.N), by=c(catcol, colname)]\n      impurities &lt;- counts[, list(GI=sum((N/sum(N))*(1-N/sum(N)))), by=catcol]\n      impuritiesDT[impurities, GI := GI]\n      setnames(impuritiesDT, \"GI\", colname)\n    }\n\n    cats1.gini &lt;- melt(impuritiesDT, id.vars=c(catcol, \"Samples\"))\n    cats1.gini &lt;- cats1.gini[, list(GI=weighted.mean(x=value, w=Samples)), by=variable]\n    cats1.gini &lt;- cats1.gini[, list(Var1=catcol, Var2=variable, GI)]\n    varpairs[cats1.gini, `:=`(GI=i.GI), on=c(\"Var1\", \"Var2\")]\n  }\n\n  return(varpairs[])\n}\n\nginiImpurities(dt)\n      Var1    Var2        GI\n1:  Letter  Letter 0.0000000\n2:  Letter Letter2 0.9615258\n3:  Letter  PGroup 0.9999537\n4: Letter2  Letter 0.9615254\n5: Letter2 Letter2 0.0000000\n6: Letter2  PGroup 0.9999537\n7:  PGroup  Letter 0.9471393\n8:  PGroup Letter2 0.9470965\n9:  PGroup  PGroup 0.0000000\n</code></pre>\n", "tags": ["r", "data.table"], "creation_date": 1473023071, "score": 1, "last_activity_date": 1473023071, "answer_id": 39321486, "is_accepted": false, "owner": {"user_id": 2146894, "reputation": 3250, "user_type": "registered", "accept_rate": 81, "display_name": "Ben", "link": "http://stackoverflow.com/users/2146894/ben", "profile_image": "https://www.gravatar.com/avatar/1fe765256b6985ff92d0554dbcf021aa?s=128&d=identicon&r=PG"}, "title": "data.table slow aggregating on factor column", "question_id": 39320840}