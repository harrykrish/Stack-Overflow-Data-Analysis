{"title": "Android Camera2 API YUV_420_888 to JPEG", "tags": ["java", "android", "android-camera2", "camera2"], "creation_date": 1476960136, "score": 1, "body": "<p>I solved this problem by using <strong><a href=\"https://developer.android.com/reference/android/graphics/ImageFormat.html#YUV_420_888\" rel=\"nofollow\">YUV_420_888</a></strong> image format and converting it to <strong><a href=\"https://developer.android.com/reference/android/graphics/ImageFormat.html#JPEG\" rel=\"nofollow\">JPEG</a></strong> image format manually.<br></p>\n\n<pre><code>imageReader = ImageReader.newInstance(MAX_PREVIEW_WIDTH, MAX_PREVIEW_HEIGHT, \n                                      ImageFormat.YUV_420_888, 5);\nimageReader.setOnImageAvailableListener(this, null);\n</code></pre>\n\n<hr>\n\n<pre><code>Surface imageSurface = imageReader.getSurface();\nList&lt;Surface&gt; surfaceList = new ArrayList&lt;&gt;();\n//...add other surfaces\npreviewRequestBuilder = cameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);\npreviewRequestBuilder.addTarget(imageSurface);\n            surfaceList.add(imageSurface);\ncameraDevice.createCaptureSession(surfaceList,\n                    new CameraCaptureSession.StateCallback() {\n//...implement onConfigured, onConfigureFailed for StateCallback\n}, null);\n</code></pre>\n\n<hr>\n\n<pre><code>@Override\npublic void onImageAvailable(ImageReader reader) {\n    Image image = reader.acquireLatestImage();\n    if (image != null) {\n        //converting to JPEG\n        byte[] jpegData = ImageUtils.imageToByteArray(image);\n        //write to file (for example ..some_path/frame.jpg)\n        FileManager.writeFrame(FILE_NAME, jpegData);\n    }\n}\n</code></pre>\n\n<hr>\n\n<pre><code>public final class ImageUtil {\n\n    public static byte[] imageToByteArray(Image image) {\n        byte[] data = null;\n        if (image.getFormat() == ImageFormat.JPEG) {\n            Image.Plane[] planes = image.getPlanes();\n            ByteBuffer buffer = planes[0].getBuffer();\n            data = new byte[buffer.capacity()];\n            buffer.get(data);\n            return data;\n        } else if (image.getFormat() == ImageFormat.YUV_420_888) {\n            data = NV21toJPEG(\n                    YUV_420_888toNV21(image),\n                    image.getWidth(), image.getHeight());\n        }\n        return data;\n    }\n\n    private static byte[] YUV_420_888toNV21(Image image) {\n        byte[] nv21;\n        ByteBuffer yBuffer = image.getPlanes()[0].getBuffer();\n        ByteBuffer uBuffer = image.getPlanes()[1].getBuffer();\n        ByteBuffer vBuffer = image.getPlanes()[2].getBuffer();\n\n        int ySize = yBuffer.remaining();\n        int uSize = uBuffer.remaining();\n        int vSize = vBuffer.remaining();\n\n        nv21 = new byte[ySize + uSize + vSize];\n\n        //U and V are swapped\n        yBuffer.get(nv21, 0, ySize);\n        vBuffer.get(nv21, ySize, vSize);\n        uBuffer.get(nv21, ySize + vSize, uSize);\n\n        return nv21;\n    }\n\n    private static byte[] NV21toJPEG(byte[] nv21, int width, int height) {\n        ByteArrayOutputStream out = new ByteArrayOutputStream();\n        YuvImage yuv = new YuvImage(nv21, ImageFormat.NV21, width, height, null);\n        yuv.compressToJpeg(new Rect(0, 0, width, height), 100, out);\n        return out.toByteArray();\n    }\n}\n</code></pre>\n\n<hr>\n\n<pre><code>public final class FileManager {\n    public static void writeFrame(String fileName, byte[] data) {\n        try {\n            BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream(fileName));\n            bos.write(data);\n            bos.flush();\n            bos.close();\n//            Log.e(TAG, \"\" + data.length + \" bytes have been written to \" + filesDir + fileName + \".jpg\");\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n    }\n}\n</code></pre>\n", "last_activity_date": 1476962912, "answer_id": 40152147, "is_accepted": true, "owner": {"user_id": 3226984, "reputation": 1746, "user_type": "registered", "accept_rate": 76, "display_name": "Vladimir Kulyk", "link": "http://stackoverflow.com/users/3226984/vladimir-kulyk", "profile_image": "https://i.stack.imgur.com/cGb7o.jpg?s=128&g=1"}, "last_edit_date": 1476962912, "question_id": 40090681}